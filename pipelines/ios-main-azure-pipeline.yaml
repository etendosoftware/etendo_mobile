variables:
  P12SecureFileId: f5ebc007-cdc0-4c03-9e7d-a7e0c5de5efc
  MobileProvisionSecureFileId: ca1a75cd-d8c7-4b66-b43c-c1f976309e37
  AppExtensionProvisionSecureFiles: >-
    [{"fileId":"cfa9cd9a-3b43-4a7e-827b-fa4f66bbdf50","fileName":"Etendo_Recieve_Share.mobileprovision","targetBundleIdentifier":"com.etendoapploader.ios.EtendoRecieveShare"}]
  MobileProvision: >-
    {"expirationDate":"2026-12-17T13:34:03Z","teamIdentifier":"B4T44MT553","type":"app-store","bundleIdentifier":"com.etendoapploader.ios","UUID":"9dcc02fc-0024-46fe-b528-5126536be0b3"}
  APPCENTER_XCODE_PROJECT: ios/Etendo_Mobile.xcworkspace
  APPCENTER_XCODE_WORKSPACE: ios/Etendo_Mobile.xcworkspace
  sonoma.tags: 'continuous,javascript,xcode,signed,distribution'
  artifactVersioning.build.value: '0'
  # Additional variables required
  APPLE_CERTIFICATE_SIGNING_IDENTITY: 'iPhone Distribution: FUTIT SERVICES SRL (B4T44MT553)'
name: $(artifactVersioning.build.value)
resources:
  repositories:
    - repository: self
      type: git
      ref: refs/heads/$(Build.SourceBranch)

pr: none
jobs:
  - job: Phase_1
    displayName: Build
    cancelTimeoutInMinutes: 0
    pool:
      name: Azure Pipelines
      vmImage: macOS-14
    steps:
      - checkout: self
        clean: true
        submodules: recursive
        lfs: true
      
      # Check and create script directory if it does not exist
      - task: Bash@3
        displayName: Create scripts directory
        inputs:
          targetType: 'inline'
          script: |
            echo "Creating scripts directory..."
            mkdir -p $(Agent.HomeDirectory)/scripts
            ls -la $(Agent.HomeDirectory)/
          failOnStderr: false
      
      - task: PowerShell@2
        displayName: Install build scripts
        continueOnError: true
        inputs:
          targetType: inline
          scriptName: ''
          script: >-
            Set-Location -Path '$(Agent.HomeDirectory)'

            Invoke-WebRequest -Uri
            'https://build-assets.appcenter.ms/buildscripts/appcenter-build-assets-latest.zip'
            -OutFile 'appcenter-build-assets-latest.zip'

            if (Test-Path ./scripts) { Remove-Item -Path ./scripts -Force
            -Recurse }

            New-Item -ItemType directory -Path 'scripts' | Out-Null

            unzip -q -d 'scripts' 'appcenter-build-assets-latest.zip'

            # Verificar que los archivos se extrajeron correctamente
            Get-ChildItem -Path './scripts' -Recurse | Select-Object Name, FullName

            Invoke-Expression 'bash ./scripts/init.sh'
          failOnStderr: false
      
      # Verify that the scripts are available
      - task: Bash@3
        displayName: Verify scripts installation
        inputs:
          targetType: 'inline'
          script: |
            echo "Checking scripts directory:"
            ls -la $(Agent.HomeDirectory)/scripts/
            echo "Looking for select-node-version.sh:"
            find $(Agent.HomeDirectory)/scripts/ -name "*node*" -type f || echo "No node-related scripts found"
            find $(Agent.HomeDirectory)/scripts/ -name "select-node-version.sh" -type f || echo "select-node-version.sh not found"
          failOnStderr: false
      
      - task: ShellScript@2
        displayName: Post Clone Script
        condition: succeeded()
        inputs:
          scriptPath: appcenter-post-clone.sh
      
      # Alternative 1: Use NodeTool task instead of custom script
      - task: NodeTool@0
        displayName: 'Use Node 18.x'
        inputs:
          versionSpec: '18.x'
      
      # Alternative 2: If you need to use the script, verify its existence first.
      - task: Bash@3
        displayName: Select Node.js Version v2 (Alternative)
        condition: false  # Disabled by default, enable if necessary
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/select-node-version.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              echo "Running select-node-version.sh..."
              bash "$SCRIPT_PATH" node18
            else
              echo "Script not found at $SCRIPT_PATH, using direct node setup..."
              # Configurar Node.js directamente usando nvm o similar
              if command -v nvm &> /dev/null; then
                nvm use 18 || nvm install 18
              elif command -v nodenv &> /dev/null; then
                nodenv global 18.19.0 || nodenv install 18.19.0
              else
                echo "Node.js setup completed via NodeTool task"
              fi
            fi
          failOnStderr: false
      
      - task: CmdLine@1
        displayName: yarn/npm install
        inputs:
          filename: sh
          arguments: >-
            -c "if [ -f yarn.lock ]; then { yarn install
            --network-timeout=600000; } else npm install; fi"
      
      - task: CmdLine@2
        displayName: Generate source map
        inputs:
          script: >-
            #!/bin/sh

            INDEX_FILE="index.ios.js"

            if [ -f "index.js" ]; then
              INDEX_FILE="index.js"
            fi

            echo "Found $INDEX_FILE for ReactNative index."

            if [ ! -f ./node_modules/react-native/local-cli/cli.js ]; then
              mkdir -p ./node_modules/react-native/local-cli
             echo "require('@react-native-community/cli').run();" >> ./node_modules/react-native/local-cli/cli.js
            fi

            node --max_old_space_size=8192
            node_modules/react-native/local-cli/cli.js bundle --entry-file
            $INDEX_FILE --platform ios --dev false --reset-cache --bundle-output
            dummy-sourcemap-main.jsbundle --sourcemap-output index.ios.map
          failOnStandardError: false
      
      - task: CmdLine@1
        displayName: Copy source map file to staging
        inputs:
          filename: sh
          arguments: >-
            -c "mkdir -p $(build.artifactstagingdirectory)/symbols && cp
            index.ios.map $(build.artifactstagingdirectory)/symbols/"
          failOnStandardError: true
      
      # Verify that emit-tags.sh exists before running it.
      - task: Bash@3
        displayName: Tag build (with verification)
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/emit-tags.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              echo "Running emit-tags.sh..."
              bash "$SCRIPT_PATH" $(sonoma.tags)
            else
              echo "emit-tags.sh not found, creating tags manually..."
              echo "##vso[build.addbuildtag]continuous"
              echo "##vso[build.addbuildtag]javascript"
              echo "##vso[build.addbuildtag]xcode"
              echo "##vso[build.addbuildtag]signed"
              echo "##vso[build.addbuildtag]distribution"
            fi
          failOnStderr: false
      
      - task: Bash@3
        displayName: "Select Xcode 16 (iOS 18 SDK)"
        inputs:
          targetType: 'inline'
          script: |
              echo "macOS version:"
              sw_vers -productVersion

              echo "=== Available Xcode installations ==="
              ls -la /Applications | grep 'Xcode' || true

              # Prefer explicit Xcode 16.*
              XCODE_CANDIDATE=$(ls /Applications | grep -E '^(Xcode_16|Xcode 16)' | grep -vi beta | head -n 1)

              if [ -z "$XCODE_CANDIDATE" ]; then
                echo "ERROR: Xcode 16 not found on this agent."
                echo "Available versions:"
                ls /Applications | grep 'Xcode' || true
                exit 1
              fi

              echo "Selected Xcode: $XCODE_CANDIDATE"
              XCODE_PATH="/Applications/$XCODE_CANDIDATE/Contents/Developer"
              echo "##vso[task.setvariable variable=XCODE_DEVELOPER_DIR]$XCODE_PATH"

              echo "Selecting Xcode..."
              sudo xcode-select -s "$XCODE_PATH"

              echo "Verification:"
              xcrun xcode-select --print-path
              xcodebuild -version
              echo "Expecting iOS SDK 18 or later:"
              xcodebuild -showsdks | grep -E 'iphoneos|iphonesimulator' || true

      - task: DownloadSecureFile@1
        name: caCert
        inputs:
          secureFile: $(P12SecureFileId)

      - task: InstallAppleCertificate@2
        displayName: 'Install Apple Certificate'
        inputs:
          certSecureFile: $(P12SecureFileId)
          certPwd: $(P12Password)
            
      - task: Bash@3
        displayName: 'Verify Signing Identity'
        inputs:
          targetType: 'inline'
          script: |
            echo "=== Identities in keychain ==="
            security find-identity -v -p codesigning
            
            echo "=== Verifying certificate and private key ==="
            security find-certificate -a -c "$(APPLE_CERTIFICATE_SIGNING_IDENTITY)" -Z
      
      - task: InstallAppleProvisioningProfile@0
        name: mainAppProv
        displayName: Install Main App Provisioning Profile
        inputs:
          provProfileSecureFile: $(MobileProvisionSecureFileId)
      
      - task: InstallAppleProvisioningProfile@0
        name: extensionProv
        displayName: Install Extension Provisioning Profile
        inputs:
          provProfileSecureFile: cfa9cd9a-3b43-4a7e-827b-fa4f66bbdf50
      
      # Verify that certificates and provisioning profiles are correctly installed.
      - task: Bash@3
        displayName: Verify certificates and provisioning profiles
        inputs:
          targetType: 'inline'
          script: |
            echo "=== Verificando certificados instalados ==="
            security find-identity -v -p codesigning
            
            echo "=== Verificando provisioning profiles ==="
            ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
            for f in ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision; do
              echo "Profile: $f"
              security cms -D -i "$f" | grep -A 1 "Name" | grep "string"
              security cms -D -i "$f" | grep -A 1 "UUID" | grep "string"
            done
            
            echo "=== Verificando keychain ==="
            security list-keychains
            security default-keychain
            
            echo "=== Verificando configuraciÃ³n de Xcode ==="
            xcodebuild -showsdks
          failOnStderr: false
      
      - task: Bash@3
        displayName: 'Fix Podfile and Deployment Target'
        inputs:
          targetType: 'inline'
          script: |
            echo "Updating Podfile post_install hook..."
            # Use ruby to safely inject the deployment target fix into the existing post_install block
            ruby -i -pe '
              if $_ =~ /post_install do \|installer\|/
                $in_post_install = true
              elsif $in_post_install && $_ =~ /^  end/
                puts "    installer.pods_project.targets.each do |target|"
                puts "      target.build_configurations.each do |config|"
                puts "        config.build_settings[\"IPHONEOS_DEPLOYMENT_TARGET\"] = \"12.0\""
                puts "        config.build_settings[\"ENABLE_BITCODE\"] = \"NO\""
                puts "      end"
                puts "    end"
                $in_post_install = false
              end
            ' ios/Podfile
            
            echo "Updated Podfile content:"
            cat ios/Podfile

      # Update iOS Deployment Target before CocoaPods
      - task: Bash@3
        displayName: Update iOS Deployment Target
        inputs:
          targetType: 'inline'
          script: |
            echo "Updating iOS Deployment Target to 12.0..."

                  echo "Updating iOS Deployment Target to 12.0..."
      
                  # Actualizar en el proyecto principal
                  find . -name "*.pbxproj" -exec sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 11.0/IPHONEOS_DEPLOYMENT_TARGET = 12.0/g' {} \;
                  find . -name "*.pbxproj" -exec sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = "11.0"/IPHONEOS_DEPLOYMENT_TARGET = "12.0"/g' {} \;
      
                  # Actualizar en Podfile si existe
                  if [ -f "ios/Podfile" ]; then
                    echo "Updating Podfile..."
                    sed -i '' "s/platform :ios, '11.0'/platform :ios, '12.0'/g" ios/Podfile
                    sed -i '' "s/platform :ios, \"11.0\"/platform :ios, \"12.0\"/g" ios/Podfile
                    # Si no hay platform definido, agregarlo
                    if ! grep -q "platform :ios" ios/Podfile; then
                      echo "Adding iOS platform to Podfile..."
                      sed -i '' '1i\
                    platform :ios, '\''12.0'\''
                    ' ios/Podfile
                    fi
                  fi
      
                  # Verificar cambios
                  echo "Checking current deployment targets:"
                  grep -r "IPHONEOS_DEPLOYMENT_TARGET" ios/ || echo "No deployment targets found"
      - task: Bash@3
        displayName: 'Fix glog URL and Pod Install Retry'
        inputs:
          targetType: 'inline'
          script: |
            echo "Applying glog URL fix..."
            # Some versions of RN have a problematic URL for glog
            find node_modules -name "glog.podspec" -exec sed -i '' 's/https:\/\/github.com\/google\/glog.git/https:\/\/github.com\/google\/glog/g' {} + || true
            
            echo "Running pod install with retries..."
            cd ios
            MAX_RETRIES=3
            RETRY_COUNT=0
            until [ $RETRY_COUNT -ge $MAX_RETRIES ]
            do
               pod install && break
               RETRY_COUNT=$[$RETRY_COUNT+1]
               echo "Pod install failed. Retry $RETRY_COUNT/$MAX_RETRIES in 10 seconds..."
               sleep 10
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Pod install failed after $MAX_RETRIES attempts."
              exit 1
            fi

      # Verify that detect-autogenerated-workspace.sh exists
      - task: Bash@3
        displayName: Determine project file path (with verification)
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/detect-autogenerated-workspace.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              echo "Running detect-autogenerated-workspace.sh..."
              bash "$SCRIPT_PATH" ios Etendo_Mobile
            else
              echo "detect-autogenerated-workspace.sh not found, setting default workspace..."
              echo "##vso[task.setvariable variable=APPCENTER_XCODE_PROJECT]ios/Etendo_Mobile.xcworkspace"
            fi
          workingDirectory: $(Build.SourcesDirectory)
          failOnStderr: false

      - task: Bash@3
        displayName: Determine signing style and pods update (with verification)
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/determine-signing-style-and-pods-update.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              echo "Running determine-signing-style-and-pods-update.sh..."
              cd $(Build.SourcesDirectory)
              bash "$SCRIPT_PATH"
            else
              echo "determine-signing-style-and-pods-update.sh not found, setting manual signing..."
              echo "##vso[task.setvariable variable=SIGNING_OPTION]manual"
            fi
          failOnStderr: false
      
      - task: PowerShell@2
        displayName: Determine monotonically increasing build number
        inputs: 
          targetType: 'inline'
          script: |
            $maxBundleVersion = 2147483647
            $timestamp = Get-Date -Format "yyyyMMddHH"
            [long]$timestampValue = 0
            if (-not [long]::TryParse($timestamp, [ref]$timestampValue)) {
              throw "Unable to parse timestamp '$timestamp' into a numeric build number"
            }
            $increment = 1
            $buildIdRaw = $env:BUILD_BUILDID

            if (![string]::IsNullOrWhiteSpace($buildIdRaw)) {
              [long]$buildId = 0
              if ([long]::TryParse($buildIdRaw, [ref]$buildId) -and $buildId -gt 0) {
                $increment = (($buildId - 1) % 1000) + 1
              } else {
                Write-Warning "BUILD_BUILDID value '$buildIdRaw' is invalid. Falling back to timestamp-based increment."
              }
            } else {
              Write-Warning "BUILD_BUILDID is not available. Falling back to timestamp-based increment."
            }

            $versionCode = $timestampValue + $increment

            if ($versionCode -gt $maxBundleVersion) {
              throw "Calculated bundle version '$versionCode' exceeds the App Store Connect limit '$maxBundleVersion'"
            }
            Write-Host "Calculated bundle version: $versionCode"
            Write-Host "##vso[task.setvariable variable=versionCode]$versionCode"
            Write-Host "##vso[task.setvariable variable=BUNDLE_VERSION]$versionCode"
      
      - task: CmdLine@1
        displayName: Set Bundle version
        inputs:
          filename: /usr/bin/find
          arguments: >-
            . -name "*Info.plist" -exec /usr/libexec/PlistBuddy -c "Set
            :CFBundleVersion $(versionCode)" {} ;
      
      - task: Bash@3
        displayName: 'Update Provisioning Profiles in Project'
        inputs:
          targetType: 'inline'
          script: |
            echo "Updating provisioning profile names in project.pbxproj..."
            # Replace placeholder names with actual names from installed profiles
            # Main App
            sed -i '' "s/Etendo Mobile Distribution/$(mainAppProv.provisioningProfileName)/g" ios/Etendo_Mobile.xcodeproj/project.pbxproj
            # Extension
            sed -i '' "s/Etendo Recieve Share/$(extensionProv.provisioningProfileName)/g" ios/Etendo_Mobile.xcodeproj/project.pbxproj
            sed -i '' "s/Etendo Distribution/$(extensionProv.provisioningProfileName)/g" ios/Etendo_Mobile.xcodeproj/project.pbxproj
            
            echo "Creating exportOptions.plist..."
            cat <<EOF > $(Agent.TempDirectory)/exportOptions.plist
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>method</key>
                <string>app-store</string>
                <key>teamID</key>
                <string>B4T44MT553</string>
                <key>provisioningProfiles</key>
                <dict>
                    <key>com.etendoapploader.ios</key>
                    <string>$(mainAppProv.provisioningProfileName)</string>
                    <key>com.etendoapploader.ios.EtendoRecieveShare</key>
                    <string>$(extensionProv.provisioningProfileName)</string>
                </dict>
                <key>signingCertificate</key>
                <string>iPhone Distribution</string>
                <key>signingStyle</key>
                <string>manual</string>
                <key>destination</key>
                <string>export</string>
            </dict>
            </plist>
            EOF
            
            echo "Project updated and exportOptions.plist created."
            echo "Verifying PROVISIONING_PROFILE_SPECIFIER in project.pbxproj:"
            grep "PROVISIONING_PROFILE_SPECIFIER" ios/Etendo_Mobile.xcodeproj/project.pbxproj || echo "No specifiers found"
      
      - task: Xcode@4
        displayName: Xcode build (signed)
        inputs:
          actions: clean archive
          configuration: Release
          sdk: iphoneos
          xcWorkspacePath: $(APPCENTER_XCODE_PROJECT)
          scheme: Etendo_Mobile
          xcodeDeveloperDir: $(XCODE_DEVELOPER_DIR)
          packageApp: true
          archivePath: $(agent.builddirectory)/output/build/archive
          exportPath: $(agent.builddirectory)/output/build/export
          signingOption: manual
          signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'
          teamId: 'B4T44MT553'
          exportOptions: 'plist'
          exportOptionsPlist: '$(Agent.TempDirectory)/exportOptions.plist'
          args: >-
            -verbose
            -allowProvisioningUpdates 
            -destination generic/platform=iOS 
            PROVISIONING_PROFILE=$(mainAppProv.provisioningProfileUuid)
            PROVISIONING_PROFILE_SPECIFIER=$(mainAppProv.provisioningProfileName)
            PROVISIONING_PROFILE[com.etendoapploader.ios.EtendoRecieveShare]=$(extensionProv.provisioningProfileUuid)
            PROVISIONING_PROFILE_SPECIFIER[com.etendoapploader.ios.EtendoRecieveShare]=$(extensionProv.provisioningProfileName)
            ASSETCATALOG_COMPILER_GENERATE_ASSET_SYMBOLS=NO
            COMPILER_INDEX_STORE_ENABLE=NO
        continueOnError: false
        timeoutInMinutes: 60
      
      - task: CopyFiles@2
        displayName: Copy build files to staging
        inputs:
          SourceFolder: $(agent.builddirectory)/output/build/export
          Contents: '**/*.ipa'
          TargetFolder: $(build.artifactstagingdirectory)/build
          OverWrite: true
          flattenFolders: true
      
      - task: CopyFiles@2
        displayName: Copy symbol files to staging
        inputs:
          SourceFolder: >-
            $(agent.builddirectory)/output/build/archive/Etendo_Mobile.xcarchive/dSYMs
          Contents: '**/*.dSYM/**'
          TargetFolder: $(build.artifactstagingdirectory)/symbols
          OverWrite: true
      
      - task: PublishBuildArtifacts@1
        displayName: Publish build
        inputs:
          PathtoPublish: $(build.artifactstagingdirectory)/build
          ArtifactName: build
          TargetPath: \\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)
      
      - task: PublishBuildArtifacts@1
        displayName: Publish symbols
        continueOnError: true
        inputs:
          PathtoPublish: $(build.artifactstagingdirectory)/symbols
          ArtifactName: symbols
          TargetPath: \\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)
      
      - script: |
          echo "New version with updated features and compatibility improvements" > $(System.DefaultWorkingDirectory)/ReleaseNotes.txt
          echo "Please test compatibility with iOS 15+ and report any issues" > $(System.DefaultWorkingDirectory)/changelog.txt
        displayName: 'Create Release Notes and Changelog files'
      
      - task: AppStoreRelease@1
        inputs:
          serviceEndpoint: 'app center'
          releaseTrack: 'Production'
          ipaPath: '$(build.artifactstagingdirectory)/build/*.ipa'
          appIdentifier: 'com.etendoapploader.ios'
          appType: 'iOS'
          appSpecificId: '6451114033'
        displayName: 'Publish to App Store'