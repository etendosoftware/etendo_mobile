variables:
  P12SecureFileId: ab637576-6255-4111-881f-9925ef484173
  MobileProvisionSecureFileId: 91218312-496d-4087-8815-289bd47446be
  AppExtensionProvisionSecureFiles: >-
    [{"fileId":"105406af-28ef-4246-8494-e1db2b52ab3e","fileName":"Etendo_Recieve_Share.mobileprovision","targetBundleIdentifier":"com.etendoapploader.ios.EtendoRecieveShare"}]
  MobileProvision: >-
    {"expirationDate":"2025-12-16T18:57:43.000Z","teamIdentifier":"B4T44MT553","type":"app-store","bundleIdentifier":"com.etendoapploader.ios","UUID":"9dcc02fc-0024-46fe-b528-5126536be0b3"}
  APPCENTER_XCODE_PROJECT: ios/Etendo_Mobile.xcworkspace
  APPCENTER_XCODE_WORKSPACE: ios/Etendo_Mobile.xcworkspace
  sonoma.tags: 'continuous,javascript,xcode,signed,distribution'
  artifactVersioning.build.value: '0'
  APPLE_CERTIFICATE_SIGNING_IDENTITY: 'Apple Distribution: FUTIT SERVICES SRL (B4T44MT553)'
  
name: $(artifactVersioning.build.value)

resources:
  repositories:
    - repository: self
      type: git
      ref: refs/heads/$(Build.SourceBranch)

pr: none

jobs:
  - job: Phase_1
    displayName: Build
    cancelTimeoutInMinutes: 0
    pool:
      name: Azure Pipelines
      vmImage: macOS-14
    
    steps:
      - checkout: self
        clean: true
        submodules: recursive
        lfs: true
            
      - task: Bash@3
        displayName: Create scripts directory
        inputs:
          targetType: 'inline'
          script: |
            echo "Creating scripts directory..."
            mkdir -p $(Agent.HomeDirectory)/scripts
            ls -la $(Agent.HomeDirectory)/
          failOnStderr: false
      
      - task: PowerShell@2
        displayName: Install build scripts
        continueOnError: true
        inputs:
          targetType: inline
          script: >-
            Set-Location -Path '$(Agent.HomeDirectory)'

            Invoke-WebRequest -Uri
            'https://build-assets.appcenter.ms/buildscripts/appcenter-build-assets-latest.zip'
            -OutFile 'appcenter-build-assets-latest.zip'

            if (Test-Path ./scripts) { Remove-Item -Path ./scripts -Force -Recurse }

            New-Item -ItemType directory -Path 'scripts' | Out-Null

            unzip -q -d 'scripts' 'appcenter-build-assets-latest.zip'

            Get-ChildItem -Path './scripts' -Recurse | Select-Object Name, FullName

            Invoke-Expression 'bash ./scripts/init.sh'
          failOnStderr: false
      
      - task: Bash@3
        displayName: Verify scripts installation
        inputs:
          targetType: 'inline'
          script: |
            echo "Checking scripts directory:"
            ls -la $(Agent.HomeDirectory)/scripts/ || true
            find $(Agent.HomeDirectory)/scripts/ -name "*node*" -type f || echo "No node-related scripts found"
          failOnStderr: false
      
      - task: ShellScript@2
        displayName: Post Clone Script
        condition: succeeded()
        inputs:
          scriptPath: appcenter-post-clone.sh
      
      - task: NodeTool@0
        displayName: 'Use Node 18.x'
        inputs:
          versionSpec: '18.x'
      
      - task: Cache@2
        displayName: Cache node modules
        inputs:
          key: 'yarn | "$(Agent.OS)" | yarn.lock'
          restoreKeys: |
            yarn | "$(Agent.OS)"
            yarn
          path: $(System.DefaultWorkingDirectory)/node_modules
      
      - task: Cache@2
        displayName: Cache CocoaPods
        inputs:
          key: 'pods | "$(Agent.OS)" | ios/Podfile.lock'
          restoreKeys: |
            pods | "$(Agent.OS)"
            pods
          path: $(System.DefaultWorkingDirectory)/ios/Pods
      
      - task: Cache@2
        displayName: Cache DerivedData
        inputs:
          key: 'deriveddata | "$(Agent.OS)" | ios/Podfile.lock'
          restoreKeys: |
            deriveddata | "$(Agent.OS)"
            deriveddata
          path: $(Pipeline.Workspace)/DerivedData
      
      - task: CmdLine@1
        displayName: yarn/npm install
        inputs:
          filename: sh
          arguments: >-
            -c "if [ -f yarn.lock ]; then { yarn install --network-timeout=600000 --frozen-lockfile; } else npm ci; fi"
      
      - task: CmdLine@2
        displayName: Generate source map (optimized)
        inputs:
          script: |
            #!/bin/sh
            INDEX_FILE="index.ios.js"
            if [ -f "index.js" ]; then
              INDEX_FILE="index.js"
            fi

            echo "Found $INDEX_FILE for ReactNative index."

            if [ ! -f ./node_modules/react-native/local-cli/cli.js ]; then
              mkdir -p ./node_modules/react-native/local-cli
              echo "require('@react-native-community/cli').run();" >> ./node_modules/react-native/local-cli/cli.js
            fi

            # Optimized bundle generation with parallel processing
            node --max_old_space_size=12288 \
              node_modules/react-native/local-cli/cli.js bundle \
              --entry-file $INDEX_FILE \
              --platform ios \
              --dev false \
              --reset-cache \
              --bundle-output dummy-sourcemap-main.jsbundle \
              --sourcemap-output index.ios.map \
              --minify true
          failOnStandardError: false
      
      - task: CmdLine@1
        displayName: Copy source map file to staging
        inputs:
          filename: sh
          arguments: >-
            -c "mkdir -p $(build.artifactstagingdirectory)/symbols && cp
            index.ios.map $(build.artifactstagingdirectory)/symbols/"
          failOnStandardError: true
      
      - task: Bash@3
        displayName: Tag build
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/emit-tags.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              bash "$SCRIPT_PATH" $(sonoma.tags)
            else
              echo "##vso[build.addbuildtag]continuous"
              echo "##vso[build.addbuildtag]javascript"
              echo "##vso[build.addbuildtag]xcode"
              echo "##vso[build.addbuildtag]signed"
              echo "##vso[build.addbuildtag]distribution"
            fi
          failOnStderr: false
      
      - task: Bash@3
        displayName: "Select Xcode 16 (iOS 18 SDK)"
        inputs:
          targetType: 'inline'
          script: |
            echo "macOS version:"
            sw_vers -productVersion

            echo "=== Available Xcode installations ==="
            ls -la /Applications | grep 'Xcode' || true

            XCODE_CANDIDATE=$(ls /Applications | grep -E '^(Xcode_16|Xcode 16)' | grep -vi beta | head -n 1)

            if [ -z "$XCODE_CANDIDATE" ]; then
              echo "ERROR: Xcode 16 not found on this agent."
              ls /Applications | grep 'Xcode' || true
              exit 1
            fi

            echo "Selected Xcode: $XCODE_CANDIDATE"
            XCODE_PATH="/Applications/$XCODE_CANDIDATE/Contents/Developer"
            echo "##vso[task.setvariable variable=XCODE_DEVELOPER_DIR]$XCODE_PATH"

            sudo xcode-select -s "$XCODE_PATH"

            echo "Verification:"
            xcrun xcode-select --print-path
            xcodebuild -version
            xcodebuild -showsdks | grep -E 'iphoneos|iphonesimulator' || true
      
      - task: InstallAppleCertificate@2
        displayName: Install Apple certificate
        inputs:
          certSecureFile: $(P12SecureFileId)
          certPwd: $(P12Password)
      
      - task: InstallAppleProvisioningProfile@0
        displayName: Install main provisioning profile
        inputs:
          provProfileSecureFile: $(MobileProvisionSecureFileId)
      
      - task: InstallAppleProvisioningProfile@0
        displayName: Install extension provisioning profile
        inputs:
          provProfileSecureFile: 105406af-28ef-4246-8494-e1db2b52ab3e
      
      - task: Bash@3
        displayName: Verify certificates and provisioning profiles
        inputs:
          targetType: 'inline'
          script: |
            echo "=== Installed certificates ==="
            security find-identity -v -p codesigning
            
            echo "=== Provisioning profiles ==="
            ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || true
            
            echo "=== Keychain configuration ==="
            security list-keychains
          failOnStderr: false
      
      - task: Bash@3
        displayName: Optimize Podfile configuration
        inputs:
          targetType: 'inline'
          script: |
            echo "Optimizing Podfile..."
            if [ -f "ios/Podfile" ]; then
              # Update platform version
              sed -i '' "s/platform :ios, '11.0'/platform :ios, '12.0'/g" ios/Podfile 2>/dev/null || true
              sed -i '' "s/platform :ios, \"11.0\"/platform :ios, \"12.0\"/g" ios/Podfile 2>/dev/null || true
              
              if ! grep -q "platform :ios" ios/Podfile; then
                sed -i '' '1i\
            platform :ios, '\''12.0'\''
            ' ios/Podfile
              fi
              
              # Remove existing post_install hook if present using Python
              if grep -q "post_install" ios/Podfile; then
                echo "Removing existing post_install hook..."
                python3 << 'PYTHON_SCRIPT'
            with open('ios/Podfile', 'r') as f:
                lines = f.readlines()
            
            output = []
            in_post_install = False
            block_depth = 0
            
            for line in lines:
                if 'post_install do' in line:
                    in_post_install = True
                    block_depth = 1
                    continue
                
                if in_post_install:
                    if line.strip().startswith('end'):
                        block_depth -= 1
                        if block_depth == 0:
                            in_post_install = False
                        continue
                    elif ' do ' in line or line.strip().endswith(' do'):
                        block_depth += 1
                        continue
                    else:
                        continue
                
                output.append(line)
            
            with open('ios/Podfile', 'w') as f:
                f.writelines(output)
            PYTHON_SCRIPT
              fi
              
              # Remove any existing SWIFT_OPTIMIZATION_LEVEL settings from Podfile
              if grep -q "SWIFT_OPTIMIZATION_LEVEL" ios/Podfile; then
                echo "Removing existing SWIFT_OPTIMIZATION_LEVEL settings..."
                sed -i '' '/SWIFT_OPTIMIZATION_LEVEL/d' ios/Podfile 2>/dev/null || true
              fi
              
              # Add comprehensive post_install hook
              cat >> ios/Podfile << 'PODFILE_EOF'

            post_install do |installer|
              installer.pods_project.targets.each do |target|
                target.build_configurations.each do |config|
                  config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
                  config.build_settings['ENABLE_BITCODE'] = 'NO'
                  config.build_settings['APPLICATION_EXTENSION_API_ONLY'] = 'No'
                  config.build_settings['COMPILER_INDEX_STORE_ENABLE'] = 'NO'
                  config.build_settings['DEBUG_INFORMATION_FORMAT'] = 'dwarf'
                  # Remove SWIFT_OPTIMIZATION_LEVEL to use Xcode's default Release settings
                  config.build_settings.delete('SWIFT_OPTIMIZATION_LEVEL')
                end
              end
              installer.generated_projects.each do |project|
                project.targets.each do |target|
                  target.build_configurations.each do |config|
                    config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
                    # Remove SWIFT_OPTIMIZATION_LEVEL to use Xcode's default Release settings
                    config.build_settings.delete('SWIFT_OPTIMIZATION_LEVEL')
                  end
                end
              end
            end
            PODFILE_EOF
              
              echo "Current Podfile content:"
              cat ios/Podfile
            fi
      
      - task: Bash@3
        displayName: Update iOS Deployment Target in project files
        inputs:
          targetType: 'inline'
          script: |
            echo "Updating iOS Deployment Target to 12.0..."
            
            find . -name "*.pbxproj" -exec sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 11.0/IPHONEOS_DEPLOYMENT_TARGET = 12.0/g' {} \; 2>/dev/null || true
            find . -name "*.pbxproj" -exec sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = "11.0"/IPHONEOS_DEPLOYMENT_TARGET = "12.0"/g' {} \; 2>/dev/null || true
            
            echo "Checking current deployment targets:"
            grep -r "IPHONEOS_DEPLOYMENT_TARGET" ios/ || echo "No deployment targets found"
      
      - task: Bash@3
        displayName: Clean Pods for fresh install
        inputs:
          targetType: 'inline'
          script: |
            echo "Cleaning Pods directory..."
            cd ios
            rm -rf Pods
            rm -rf Podfile.lock
            echo "✅ Pods cleaned - will be reinstalled with correct deployment target"
      
      - task: CocoaPods@0
        displayName: Pod install (optimized)
        inputs:
          cwd: ios
          forceRepoUpdate: false
      
      - task: Bash@3
        displayName: Determine project file path
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/detect-autogenerated-workspace.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              bash "$SCRIPT_PATH" ios Etendo_Mobile
            else
              echo "##vso[task.setvariable variable=APPCENTER_XCODE_PROJECT]ios/Etendo_Mobile.xcworkspace"
            fi
          workingDirectory: $(Build.SourcesDirectory)
          failOnStderr: false

      - task: Bash@3
        displayName: Determine signing style
        inputs:
          targetType: 'inline'
          script: |
            SCRIPT_PATH="$(Agent.HomeDirectory)/scripts/determine-signing-style-and-pods-update.sh"
            if [ -f "$SCRIPT_PATH" ]; then
              cd $(Build.SourcesDirectory)
              bash "$SCRIPT_PATH"
            else
              echo "##vso[task.setvariable variable=SIGNING_OPTION]manual"
            fi
          failOnStderr: false
      
      - task: PowerShell@2
        displayName: Determine monotonically increasing build number
        inputs: 
          targetType: 'inline'
          script: |
            $maxBundleVersion = 2147483647
            $timestamp = Get-Date -Format "yyyyMMddHH"
            [long]$timestampValue = 0
            if (-not [long]::TryParse($timestamp, [ref]$timestampValue)) {
              throw "Unable to parse timestamp '$timestamp' into a numeric build number"
            }
            $increment = 1
            $buildIdRaw = $env:BUILD_BUILDID

            if (![string]::IsNullOrWhiteSpace($buildIdRaw)) {
              [long]$buildId = 0
              if ([long]::TryParse($buildIdRaw, [ref]$buildId) -and $buildId -gt 0) {
                $increment = (($buildId - 1) % 1000) + 1
              }
            }

            $versionCode = $timestampValue + $increment

            if ($versionCode -gt $maxBundleVersion) {
              throw "Calculated bundle version '$versionCode' exceeds the App Store Connect limit '$maxBundleVersion'"
            }
            Write-Host "Calculated bundle version: $versionCode"
            Write-Host "##vso[task.setvariable variable=versionCode]$versionCode"
            Write-Host "##vso[task.setvariable variable=BUNDLE_VERSION]$versionCode"
      
      - task: CmdLine@1
        displayName: Set Bundle version
        inputs:
          filename: /usr/bin/find
          arguments: >-
            . -name "*Info.plist" -exec /usr/libexec/PlistBuddy -c "Set
            :CFBundleVersion $(versionCode)" {} ;
      
      - task: Bash@3
        displayName: Optimize Xcode build with parallel compilation
        inputs:
          targetType: 'inline'
          script: |
            #!/bin/bash
            set -e
            
            # Create output directories
            echo "Creating output directories..."
            mkdir -p "$(agent.builddirectory)/output/build/archive"
            mkdir -p "$(agent.builddirectory)/output/build/export"
            
            # Get number of CPU cores for parallel builds
            NCPU=$(sysctl -n hw.ncpu)
            echo "Building with $NCPU parallel jobs"
            
            # Build with optimizations
            echo "Starting archive build..."
            xcodebuild \
              -workspace "$(APPCENTER_XCODE_PROJECT)" \
              -scheme "Etendo_Mobile" \
              -configuration Release \
              -sdk iphoneos \
              -destination 'generic/platform=iOS' \
              -archivePath "$(agent.builddirectory)/output/build/archive/Etendo_Mobile.xcarchive" \
              -derivedDataPath "$(Pipeline.Workspace)/DerivedData" \
              -parallelizeTargets \
              -jobs $NCPU \
              -UseModernBuildSystem=YES \
              -allowProvisioningUpdates \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="$(APPLE_CERTIFICATE_SIGNING_IDENTITY)" \
              PROVISIONING_PROFILE_SPECIFIER="" \
              PROVISIONING_PROFILE="9dcc02fc-0024-46fe-b528-5126536be0b3" \
              DEVELOPMENT_TEAM="B4T44MT553" \
              COMPILER_INDEX_STORE_ENABLE=NO \
              DEBUG_INFORMATION_FORMAT=dwarf \
              SWIFT_COMPILATION_MODE=wholemodule \
              GCC_OPTIMIZATION_LEVEL=s \
              ENABLE_BITCODE=NO \
              CLANG_ENABLE_MODULE_DEBUGGING=NO \
              ONLY_ACTIVE_ARCH=NO \
              archive 2>&1 | tee xcodebuild.log
            
            # Check if archive was created
            if [ ! -d "$(agent.builddirectory)/output/build/archive/Etendo_Mobile.xcarchive" ]; then
              echo "ERROR: Archive was not created"
              echo "Last 50 lines of build log:"
              tail -50 xcodebuild.log
              exit 1
            fi
            
            echo "✅ Archive created successfully"
            
            # Export IPA
            echo "Exporting IPA..."
            
            # Create export options plist
            cat > /tmp/ExportOptions.plist <<EOF
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>B4T44MT553</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                <key>com.etendoapploader.ios</key>
                <string>9dcc02fc-0024-46fe-b528-5126536be0b3</string>
                <key>com.etendoapploader.ios.EtendoRecieveShare</key>
                <string>105406af-28ef-4246-8494-e1db2b52ab3e</string>
              </dict>
            </dict>
            </plist>
            EOF
            
            xcodebuild \
              -exportArchive \
              -archivePath "$(agent.builddirectory)/output/build/archive/Etendo_Mobile.xcarchive" \
              -exportPath "$(agent.builddirectory)/output/build/export" \
              -exportOptionsPlist /tmp/ExportOptions.plist \
              -allowProvisioningUpdates 2>&1 | tee -a xcodebuild.log
            
            # Check if IPA was created
            if [ ! -f "$(agent.builddirectory)/output/build/export/"*.ipa ]; then
              echo "ERROR: IPA was not created"
              echo "Contents of export directory:"
              ls -la "$(agent.builddirectory)/output/build/export/"
              echo "Last 50 lines of build log:"
              tail -50 xcodebuild.log
              exit 1
            fi
            
            echo "✅ IPA exported successfully"
            ls -lh "$(agent.builddirectory)/output/build/export/"*.ipa
            
            echo "Build and export completed successfully"
          workingDirectory: $(Build.SourcesDirectory)
          failOnStderr: false
        env:
          XCODE_DEVELOPER_DIR: $(XCODE_DEVELOPER_DIR)
        continueOnError: false
        timeoutInMinutes: 45
      
      
      - task: CopyFiles@2
        displayName: Copy build files to staging
        inputs:
          SourceFolder: $(agent.builddirectory)/output/build/export
          Contents: '**/*.ipa'
          TargetFolder: $(build.artifactstagingdirectory)/build
          OverWrite: true
          flattenFolders: true
      
      - task: CopyFiles@2
        displayName: Copy symbol files to staging
        inputs:
          SourceFolder: >-
            $(agent.builddirectory)/output/build/archive/Etendo_Mobile.xcarchive/dSYMs
          Contents: '**/*.dSYM/**'
          TargetFolder: $(build.artifactstagingdirectory)/symbols
          OverWrite: true
      
      - task: PublishBuildArtifacts@1
        displayName: Publish build
        inputs:
          PathtoPublish: $(build.artifactstagingdirectory)/build
          ArtifactName: build
          TargetPath: \\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)
      
      - task: PublishBuildArtifacts@1
        displayName: Publish symbols
        continueOnError: true
        inputs:
          PathtoPublish: $(build.artifactstagingdirectory)/symbols
          ArtifactName: symbols
          TargetPath: \\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)
      
      - script: |
          echo "New version with updated features and compatibility improvements" > $(System.DefaultWorkingDirectory)/ReleaseNotes.txt
          echo "Please test compatibility with iOS 15+ and report any issues" > $(System.DefaultWorkingDirectory)/changelog.txt
        displayName: 'Create Release Notes and Changelog files'
      
      - task: AppStoreRelease@1
        inputs:
          serviceEndpoint: 'app center'
          releaseTrack: 'Production'
          ipaPath: '$(build.artifactstagingdirectory)/build/*.ipa'
          appIdentifier: 'com.etendoapploader.ios'
          appType: 'iOS'
          appSpecificId: '6451114033'
        displayName: 'Publish to App Store'